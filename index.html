<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ისტორიული ბრძოლები წლების მიხედვით</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- CSS ნაწილი --- */
        :root {
            --primary-bg-overlay: rgba(20, 20, 20, 0.8);
            --container-bg: rgba(35, 35, 35, 0.95);
            --modal-bg: rgba(30, 30, 30, 0.98);
            --border-color: rgba(70, 70, 70, 0.7);
            --text-primary: #E0E0E0;
            --text-secondary: #B0B0B0;
            --text-dark: #222222;
            --accent-gold: #FFD700;
            --accent-green: #4CAF50;
            --accent-red: #F44336;
            --button-primary: #5A4C3D;
            --button-hover: #7E6A5B;
            --button-active: #40362D;
            
            --paper-texture-url: url('https://s.tmimgcdn.com/scr/800x500/331800/vintage-paper-a-graphic-paper-texture-background_331899-original.jpg');
            
            --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.4);
            --shadow-medium: 0 8px 20px rgba(0, 0, 0, 0.6);
            --transition-fast: 0.2s ease-out;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease-in-out;
        }

        /* General resets and base styles */
        body {
            font-family: 'Merriweather', serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: var(--text-primary);
            
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Henri_IV_%C3%A0_la_bataille_d%27Ivry.jpg/1920px-Henri_IV_%C3%A0_la_bataille_d%27Ivry.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-bg-overlay);
            z-index: -1;
            pointer-events: none;
        }

        .container {
            background-color: var(--container-bg);
            backdrop-filter: blur(5px);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            text-align: center;
            max-width: 950px;
            width: 90%;
            border: 1px solid var(--border-color);
            margin-top: 60px;
            margin-bottom: 80px;
            position: relative;
            z-index: 1;
            overflow: hidden;
            animation: fadeIn var(--transition-slow) ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-family: 'Playfair Display', serif;
            color: var(--accent-gold);
            margin-top: 0;
            margin-bottom: 35px;
            font-size: 3em;
            font-weight: 700;
            letter-spacing: 1px;
            line-height: 1.2;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            padding-bottom: 15px;
            position: relative;
        }
        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background-color: var(--accent-gold);
            border-radius: 2px;
        }
        h1 i {
            margin-right: 15px;
            color: var(--accent-gold);
        }

        /* Side Navigation - Moved to Left */
        .side-nav {
            position: fixed;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
            background-color: var(--container-bg);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px 10px;
            box-shadow: var(--shadow-medium);
            animation: slideInLeft 0.7s ease-out forwards;
        }

        @keyframes slideInLeft {
            from { transform: translateY(-50%) translateX(-100px); opacity: 0; }
            to { transform: translateY(-50%) translateX(0); opacity: 1; }
        }

        .side-nav .action-button {
            background: none;
            border: none;
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            text-decoration: none;
        }

        .side-nav .action-button i {
            font-size: 2.2em;
            margin-bottom: 8px;
            color: var(--accent-gold);
            transition: color var(--transition-normal), transform var(--transition-normal);
        }

        .side-nav .action-button .tooltiptext {
            visibility: hidden;
            opacity: 0;
            width: 120px;
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 0;
            position: absolute;
            z-index: 10;
            left: 110%; /* Tooltip to the right */
            top: 50%;
            transform: translateY(-50%);
            transition: opacity 0.3s, transform 0.3s;
            font-size: 0.8em;
            font-family: 'Merriweather', serif;
            pointer-events: none;
            white-space: nowrap;
        }

        .side-nav .action-button .tooltiptext::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 100%; /* Arrow on the left */
            margin-top: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent rgba(0, 0, 0, 0.85) transparent transparent;
        }

        .side-nav .action-button:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
            transform: translateY(-50%) translateX(5px);
        }

        .side-nav .action-button:hover {
            color: var(--accent-gold);
            transform: scale(1.05);
        }
        .side-nav .action-button:hover i {
            color: var(--accent-gold);
            transform: translateY(-3px);
        }
        .side-nav .action-button:active {
            transform: scale(0.98);
        }

        /* Input Section */
        .input-section {
            margin-bottom: 35px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
        }

        .input-group {
            flex: 1 1 280px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        label {
            font-size: 1.05em;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        label i {
            color: var(--accent-gold);
        }

        input[type="text"], input[type="email"], textarea, select, input[type="number"] {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--text-primary);
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal), background-color var(--transition-normal);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.6);
        }

        input[type="text"]::placeholder, input[type="email"]::placeholder, textarea::placeholder, input[type="number"]::placeholder {
            color: rgba(220, 220, 220, 0.6);
            opacity: 1;
        }

        input[type="text"]:focus, input[type="email"]:focus, textarea:focus, select:focus, input[type="number"]:focus {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3), inset 0 1px 3px rgba(0,0,0,0.6);
            outline: none;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        select#quizLengthSelect {
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        select#quizLengthSelect option {
            background-color: var(--container-bg);
            color: var(--text-primary);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            padding: 12px 25px;
            background-color: var(--button-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: background-color var(--transition-normal), transform var(--transition-fast), box-shadow var(--transition-normal);
            box-shadow: var(--shadow-light);
            flex-shrink: 0;
            min-width: 120px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'Merriweather', serif;
        }

        button:hover {
            background-color: var(--button-hover);
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        button:active {
            background-color: var(--button-active);
            transform: translateY(0);
            box-shadow: var(--shadow-light);
        }
        
        button.success {
            background-color: var(--accent-green);
        }
        button.success:hover {
            background-color: color-mix(in srgb, var(--accent-green) 80%, black);
        }
        button.error {
            background-color: var(--accent-red);
        }
        button.error:hover {
            background-color: color-mix(in srgb, var(--accent-red) 80%, black);
        }

        .paper-effect {
            margin-top: 35px;
            padding: 30px;
            background-image: var(--paper-texture-url);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: var(--text-dark);
            border: 2px solid rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            font-size: 1.1em;
            text-align: left;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            line-height: 1.7;
            text-align: center;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.7), -1px -1px 2px rgba(255, 255, 255, 0.7);
        }
        .paper-effect p {
            margin: 0;
            padding: 0;
        }

        .knowledge-feedback {
            margin-top: 30px;
            display: none;
            justify-content: center;
            gap: 20px;
            padding-top: 25px;
            border-top: 1px solid var(--border-color);
            animation: fadeIn 0.5s ease-out forwards;
        }

        .knowledge-feedback button {
            background-color: var(--container-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            font-weight: 500;
        }
        .knowledge-feedback button:hover {
            background-color: var(--button-hover);
            border-color: var(--button-primary);
            color: white;
        }

        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal.show {
            opacity: 1;
            display: flex;
        }

        .modal-content {
            background-color: var(--modal-bg);
            backdrop-filter: blur(10px);
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            box-shadow: var(--shadow-medium);
            position: relative;
            transform: translateY(20px);
            animation: slideInModal 0.5s ease-out forwards;
            color: var(--text-primary);
            text-align: left;
            overflow-y: auto;
            max-height: 90vh;
        }

        @keyframes slideInModal {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: var(--text-secondary);
            font-size: 30px;
            font-weight: bold;
            transition: color var(--transition-fast), transform var(--transition-fast);
            position: absolute;
            top: 15px;
            right: 20px;
            cursor: pointer;
            z-index: 10;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--accent-red);
            transform: rotate(90deg);
        }

        .modal-content h2 {
            font-family: 'Playfair Display', serif;
            color: var(--accent-gold);
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 2.2em;
            text-align: center;
            padding-bottom: 15px;
            line-height: 1.3;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            position: relative;
        }
        .modal-content h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 2px;
            background-color: var(--accent-gold);
            border-radius: 1px;
        }
        .modal-content h2 i {
            margin-right: 10px;
            color: var(--accent-gold);
        }

        .inner-modal-box {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            color: var(--text-primary);
            margin-bottom: 20px;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }
        .inner-modal-box h3 {
            font-family: 'Playfair Display', serif;
            color: var(--accent-gold);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.6em;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }
        .inner-modal-box label {
            color: var(--text-secondary);
        }
        .inner-modal-box input, .inner-modal-box textarea, .inner-modal-box select {
            background-color: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .inner-modal-box input::placeholder, .inner-modal-box textarea::placeholder {
             color: rgba(220, 220, 220, 0.6);
        }
        .inner-modal-box input:focus, .inner-modal-box textarea:focus, .inner-modal-box select:focus {
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
            background-color: rgba(0, 0, 0, 0.8);
        }

        #historyList, #knownBattlesList, #unknownBattlesList, #testQuestions, #testResults, #leaderboardList {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-gold) rgba(0, 0, 0, 0.2);
        }

        #historyList::-webkit-scrollbar,
        #knownBattlesList::-webkit-scrollbar,
        #unknownBattlesList::-webkit-scrollbar,
        #testQuestions::-webkit-scrollbar,
        #leaderboardList::-webkit-scrollbar {
            width: 8px;
        }

        #historyList::-webkit-scrollbar-track,
        #knownBattlesList::-webkit-scrollbar-track,
        #unknownBattlesList::-webkit-scrollbar-track,
        #testQuestions::-webkit-scrollbar-track,
        #leaderboardList::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        #historyList::-webkit-scrollbar-thumb,
        #knownBattlesList::-webkit-scrollbar-thumb,
        #unknownBattlesList::-webkit-scrollbar-thumb,
        #testQuestions::-webkit-scrollbar-thumb,
        #leaderboardList::-webkit-scrollbar-thumb {
            background-color: var(--accent-gold);
            border-radius: 8px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        #historyList li, #knownBattlesList li, #unknownBattlesList li, #leaderboardList li {
            padding: 15px 12px;
            border-bottom: 1px dashed rgba(70, 70, 70, 0.5);
            cursor: pointer;
            transition: background-color var(--transition-fast), transform var(--transition-fast);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            color: var(--text-primary);
        }

        #historyList li:last-child, #knownBattlesList li:last-child, #unknownBattlesList li:last-child, #leaderboardList li:last-child {
            border-bottom: none;
        }

        #historyList li:hover, #knownBattlesList li:hover, #unknownBattlesList li:hover, #leaderboardList li:hover {
            background-color: rgba(255, 255, 255, 0.05);
            transform: translateX(3px);
        }

        #historyList li span:first-child, #knownBattlesList li span:first-child, #unknownBattlesList li span:first-child {
            font-weight: 500;
        }

        .clear-history-item {
            color: var(--accent-red);
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.8;
            transition: color var(--transition-fast), opacity var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .clear-history-item:hover {
            color: darkred;
            opacity: 1;
            transform: scale(1.05);
        }

        /* --- Modal Tab Navigation (Inside Modals) --- */
        .modal-tab-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .modal-tab-nav button {
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 10px 18px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-tab-nav button.active {
            background-color: var(--button-primary);
            color: white;
            border-color: var(--button-primary);
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }
        .modal-tab-nav button:hover {
            background-color: var(--button-hover);
            border-color: var(--button-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            color: white;
        }
        .modal-tab-nav button.active:hover {
             background-color: var(--button-primary);
             color: white;
        }

        /* --- Forms Styles (Feedback, Add Battle) --- */
        #feedbackForm, #addBattleForm {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #feedbackForm button[type="submit"], #addBattleForm button[type="submit"] {
            align-self: flex-end;
            margin-top: 15px;
        }

        /* --- Test Section Styles (Revised) --- */
        #testQuizContainer {
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center content vertically */
            align-items: center;
            text-align: center;
            gap: 20px;
            padding: 15px;
        }

        .quiz-start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        .quiz-start-screen .input-group {
            width: 100%;
            max-width: 300px;
            margin-bottom: 0;
            display: flex;
            flex-direction: column; /* Stack label and select */
            align-items: center; /* Center them */
            gap: 10px;
        }

        .quiz-start-screen label {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0;
        }

        /* Quiz Content */
        #quizContent {
            display: none;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        .quiz-controls {
            display: flex;
            justify-content: space-around; /* Better spacing */
            align-items: center;
            width: 100%;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }
        .quiz-controls .score-display {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--accent-gold);
            text-align: center;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.5s;
        }
        .quiz-controls .score-display i {
            font-size: 1.3em;
        }
        #totalScoreDisplay {
            color: var(--accent-green);
        }
        #totalScoreDisplay i {
            color: var(--accent-green);
        }

        #quizCountdown {
            font-family: 'Playfair Display', serif;
            font-size: 4em;
            color: var(--accent-gold);
            text-shadow: 0 0 15px var(--accent-gold);
            animation: pulseCountdown 1s infinite;
        }
        @keyframes pulseCountdown {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }


        #questionText {
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 30px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            background-color: transparent;
            border: none;
            padding: 15px;
            line-height: 1.4;
            animation: fadeIn 0.5s ease-out;
        }
        #questionText span {
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.7);
            color: var(--accent-gold);
            margin: 0 10px;
        }


        .answer-options {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .answer-options button {
            width: 100%;
            background-color: var(--container-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 16px 20px;
            border-radius: 8px;
            font-size: 1.05em;
            font-weight: 500;
            text-align: center;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-light);
            line-height: 1.4;
            font-family: 'Merriweather', serif;
        }

        .answer-options button:hover:not(.disabled) {
            background-color: var(--button-hover);
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--shadow-medium);
            border-color: var(--button-primary);
            color: white;
        }
        
        @keyframes flipIn {
            from { transform: perspective(400px) rotate3d(1, 0, 0, 90deg); opacity: 0; }
            to { transform: perspective(400px) rotate3d(1, 0, 0, 0deg); opacity: 1; }
        }

        .answer-options button.correct {
            background-color: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
            pointer-events: none;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.7);
            transform: scale(1.05);
            animation: pulseCorrect 0.6s ease-out;
        }
        @keyframes pulseCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); box-shadow: 0 0 25px var(--accent-green); }
            100% { transform: scale(1.05); }
        }

        .answer-options button.incorrect {
            background-color: var(--accent-red);
            color: white;
            border-color: var(--accent-red);
            pointer-events: none;
            box-shadow: var(--shadow-medium);
            animation: shake 0.4s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        
        .answer-options button.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #quizFeedback {
            margin-top: 20px;
            font-weight: 600;
            font-size: 1.2em;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: var(--text-primary);
            animation: fadeIn 0.4s ease-out;
        }
        #quizFeedback .reveal-answer-icon {
            color: var(--accent-gold);
            margin-left: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #quizFeedback .reveal-answer-icon:hover {
            transform: scale(1.2);
        }

        #nextQuestionButton {
            margin-top: 25px;
            padding: 12px 30px;
            display: none;
            align-self: center;
            background-color: var(--button-primary);
            font-size: 1.1em;
        }

        /* Quiz Progress Bar */
        .quiz-progress-container {
            width: 100%;
            max-width: 500px;
            margin: 25px auto 0 auto;
            background-color: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            height: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.6);
        }

        .quiz-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-green), color-mix(in srgb, var(--accent-green) 50%, var(--accent-gold)));
            border-radius: 10px;
            transition: width 0.5s ease-out;
        }

        /* Leaderboard Specific Styles */
        #leaderboardList li {
            justify-content: flex-start;
            gap: 15px;
            font-size: 1.05em;
        }
        #leaderboardList li .rank {
            font-weight: 700;
            color: var(--accent-gold);
            min-width: 30px;
            text-align: right;
        }
        #leaderboardList li .name {
            flex-grow: 1;
        }
        #leaderboardList li .score {
            font-weight: 700;
            color: var(--accent-green);
        }

        /* Quiz End Screen Name Input */
        #quizEndScreen {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }
        #quizEndScreen .inner-modal-box {
             width: 100%;
             max-width: 500px;
        }
        #quizEndScreen label {
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 5px;
        }
        #quizEndScreen input[type="text"] {
            background-color: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            max-width: 300px;
            text-align: center;
        }
        #quizEndScreen button {
            background-color: var(--button-primary);
        }
        #quizEndScreen button:hover {
            background-color: var(--button-hover);
        }

        /* Subscribe Modal */
        #subscribeModal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.4s ease-out;
            padding: 20px;
            box-sizing: border-box;
        }

        #subscribeModal.show {
            opacity: 1;
            display: flex;
        }

        #subscribeModal .modal-content {
            background-color: var(--modal-bg);
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            text-align: center;
            padding: 40px;
            max-width: 600px;
            color: var(--text-primary);
            position: relative;
        }

        #subscribeModal h2 {
            font-size: 2.5em;
            color: var(--accent-gold);
            margin-bottom: 25px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }

        #subscribeModal p {
            font-size: 1.2em;
            margin-bottom: 30px;
            line-height: 1.8;
            color: var(--text-secondary);
        }

        #subscribeModal .price {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 30px;
        }

        #subscribeModal button {
            background-color: var(--accent-gold);
            color: var(--text-dark);
            font-size: 1.3em;
            padding: 15px 30px;
            border-radius: 10px;
            transition: all var(--transition-normal);
        }

        #subscribeModal button:hover {
            background-color: #FFEA00;
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.4);
        }

        /* --- Footer Info --- */
        .footer-info {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-top: 40px;
            margin-bottom: 30px;
            text-align: center;
            max-width: 800px;
            padding: 20px;
            background-color: var(--container-bg);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            line-height: 1.5;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 0;
                justify-content: flex-start;
            }

            .container {
                padding: 20px;
                width: 95%;
                margin-top: 80px; /* Space for the top nav */
                margin-bottom: 40px;
                border-radius: 10px;
            }

            h1 {
                font-size: 2em;
                margin-bottom: 25px;
                padding-bottom: 10px;
            }
            h1 i {
                margin-right: 8px;
            }
            h1::after {
                width: 70px;
                height: 2px;
            }

            /* NAV BECOMES A TOP BAR ON MOBILE */
            .side-nav {
                top: 0;
                left: 0;
                right: 0;
                transform: none;
                flex-direction: row;
                justify-content: space-around;
                width: 100%;
                padding: 5px;
                border-radius: 0;
                border-left: none;
                border-right: none;
                animation: none; /* Remove slide-in on mobile */
                border-top: none;
            }
            .side-nav .action-button {
                width: auto;
                height: 55px;
                font-size: 0.7em;
                flex: 1; /* Equal width for buttons */
            }
            .side-nav .action-button i {
                font-size: 1.6em;
                margin-bottom: 3px;
            }
            .side-nav .action-button .tooltiptext {
                display: none; /* Hide tooltips on mobile */
            }


            .input-section {
                flex-direction: column;
                gap: 15px;
                margin-bottom: 20px;
            }

            input[type="text"], input[type="email"], textarea, button, select, input[type="number"] {
                padding: 10px 15px;
                font-size: 0.9em;
                border-radius: 6px;
            }

            button {
                padding: 10px 20px;
                font-size: 0.95em;
                min-width: 90px;
                border-radius: 6px;
            }

            .paper-effect {
                padding: 15px;
                font-size: 0.9em;
                margin-top: 20px;
                border-radius: 8px;
            }

            .knowledge-feedback {
                flex-direction: column;
                gap: 10px;
                padding-top: 15px;
            }
            .knowledge-feedback button {
                padding: 10px 20px;
            }

            .modal-content {
                padding: 20px 15px;
                max-width: 95%;
                max-height: 95vh;
                border-radius: 12px;
            }

            .modal-content h2 {
                font-size: 1.8em;
                margin-bottom: 15px;
                padding-bottom: 10px;
            }
            .modal-content h2 i {
                margin-right: 6px;
            }
            .modal-content h2::after {
                width: 60px;
                height: 1.5px;
            }

            .close-button {
                font-size: 26px;
                top: 10px;
                right: 15px;
            }

            .inner-modal-box {
                padding: 15px;
                border-radius: 8px;
            }
            .inner-modal-box h3 {
                font-size: 1.4em;
                margin-bottom: 15px;
            }

            #historyList, #knownBattlesList, #unknownBattlesList, #testQuestions, #leaderboardList {
                max-height: 250px;
            }

            #historyList li, #knownBattlesList li, #unknownBattlesList li, #leaderboardList li {
                padding: 12px 8px;
                font-size: 0.85em;
            }

            .modal-tab-nav {
                gap: 8px;
                margin-bottom: 15px;
                padding-bottom: 8px;
            }
            .modal-tab-nav button {
                padding: 8px 14px;
                font-size: 0.8em;
                border-radius: 5px;
            }

            #testQuizContainer {
                min-height: 180px;
                gap: 15px;
            }

            .quiz-start-screen {
                gap: 15px;
            }

            .quiz-controls {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
                padding: 10px;
            }
            .quiz-controls .score-display {
                font-size: 1em;
                min-width: auto;
            }

            #questionText {
                font-size: 1.3em;
                margin-bottom: 20px;
                min-height: 60px;
                padding: 15px;
            }

            .answer-options {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .answer-options button {
                padding: 12px 15px;
                font-size: 1em;
            }

            #quizFeedback {
                font-size: 1em;
                min-height: 20px;
            }

            #nextQuestionButton {
                margin-top: 15px;
                padding: 10px 22px;
                font-size: 1em;
            }

            .quiz-progress-container {
                height: 8px;
                margin-top: 15px;
            }

            .footer-info {
                margin-top: 25px;
                margin-bottom: 20px;
                padding: 15px;
                font-size: 0.75em;
                border-radius: 8px;
            }
            
            #subscribeModal .modal-content {
                padding: 25px;
            }
            #subscribeModal h2 {
                font-size: 2em;
            }
            #subscribeModal p {
                font-size: 1em;
            }
            #subscribeModal .price {
                font-size: 2em;
            }
            #subscribeModal button {
                font-size: 1.1em;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="side-nav">
        <button class="action-button" onclick="openModal('archiveModal', 'history')">
            <i class="fas fa-book-open"></i>
            <span class="tooltiptext">ცოდნის არქივი</span>
            არქივი
        </button>
        <button class="action-button" onclick="openModal('testModal')">
            <i class="fas fa-trophy"></i>
            <span class="tooltiptext">ტესტირება</span>
            ტესტი
        </button>
        <button class="action-button" onclick="openModal('leaderboardModal')">
            <i class="fas fa-medal"></i>
            <span class="tooltiptext">ლიდერბორდი</span>
            ლიდერები
        </button>
        <button class="action-button" onclick="openModal('contributeModal', 'add')">
            <i class="fas fa-plus-circle"></i>
            <span class="tooltiptext">წვლილის შეტანა</span>
            წვლილი
        </button>
        <button class="action-button" onclick="openModal('aboutModal')">
            <i class="fas fa-info-circle"></i>
            <span class="tooltiptext">პროექტის შესახებ</span>
            შესახებ
        </button>
    </div>

    <div class="container">
        <h1><i class="fas fa-scroll"></i> ისტორიული ბრძოლები <br> წლების მიხედვით</h1>

        <div class="input-section">
            <div class="input-group">
                <label for="yearInput"><i class="fas fa-calendar-alt"></i> შეიყვანეთ წელი:</label>
                <input type="text" id="yearInput" placeholder="(მაგ: 1121, 490 ძვ. წ.)" onkeydown="if(event.keyCode === 13) getBattleInfo()">
            </div>
            <button onclick="getBattleInfo()"><i class="fas fa-search"></i> ძებნა</button>
        </div>

        <div id="battleInfo" class="paper-effect">
            <p>შეიყვანეთ წელი და გაიგეთ მეტი ისტორიული ბრძოლების შესახებ!</p>
        </div>

        <div class="knowledge-feedback" id="knowledgeFeedback">
            <button class="success" onclick="addBattleToKnowledgeList('known')"><i class="fas fa-check-circle"></i> ვიცი</button>
            <button class="error" onclick="addBattleToKnowledgeList('unknown')"><i class="fas fa-times-circle"></i> არ ვიცი</button>
        </div>
    </div>
    
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('aboutModal')">&times;</span>
            <h2><i class="fas fa-info-circle"></i> პროექტის შესახებ</h2>
            <div class="inner-modal-box" style="text-align: center; font-size: 1.1em; line-height: 1.7;">
                <p>მოგესალმებით ჩვენს ისტორიულ პორტალზე!</p>
                <p>პროექტის მიზანია, ერთ სივრცეში თავი მოუყაროს ინფორმაციას მსოფლიო და საქართველოს ისტორიაში მომხდარი მნიშვნელოვანი ბრძოლებისა და მოვლენების შესახებ. აქ შეგიძლიათ მოძებნოთ კონკრეტული წელი, შეამოწმოთ თქვენი ცოდნა ინტერაქტიული ტესტირების მეშვეობით და თქვენი წვლილიც კი შეიტანოთ ბაზის გამდიდრებაში.</p>
                <p>გისურვებთ სასიამოვნო და საინტერესო მოგზაურობას ისტორიის სამყაროში!</p>
            </div>
        </div>
    </div>


    <div id="archiveModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('archiveModal')">&times;</span>
            <h2><i class="fas fa-book-atlas"></i> ცოდნის არქივი</h2>
            <div class="modal-tab-nav">
                <button id="historyModalTab" class="active" onclick="showArchiveTab('history')"><i class="fas fa-history"></i> ძებნის ისტორია</button>
                <button id="knownModalTab" onclick="showArchiveTab('known')"><i class="fas fa-thumbs-up"></i> ვიცი</button>
                <button id="unknownModalTab" onclick="showArchiveTab('unknown')"><i class="fas fa-question-circle"></i> არ ვიცი</button>
            </div>
            <div class="inner-modal-box" id="historyContent">
                <ul id="historyList"></ul>
            </div>
            <div class="inner-modal-box" id="knownBattlesContent" style="display: none;">
                <ul id="knownBattlesList"></ul>
            </div>
            <div class="inner-modal-box" id="unknownBattlesContent" style="display: none;">
                <ul id="unknownBattlesList"></ul>
            </div>
        </div>
    </div>

    <div id="testModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('testModal')">&times;</span>
            <h2><i class="fas fa-graduation-cap"></i> ისტორიული ტესტირება</h2>
            <div class="inner-modal-box" id="testQuizContainer">
                <div class="quiz-start-screen" id="quizStartScreen">
                    <div class="input-group">
                        <label for="quizLengthSelect"><i class="fas fa-list-ol"></i> კითხვების რაოდენობა:</label>
                        <select id="quizLengthSelect">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="custom">მორგებული</option>
                        </select>
                        <input type="number" id="customQuizLengthInput" placeholder="შეიყვანეთ" min="1" style="display: none;">
                    </div>
                    <button onclick="prepareQuiz()"><i class="fas fa-play"></i> ტესტის დაწყება</button>
                </div>
                
                <div id="quizCountdown" style="display: none;"></div>

                <div id="quizContent" style="display: none;">
                    <div class="quiz-controls">
                        <div class="score-display" id="quizScore"><i class="fas fa-star"></i> ქულა: 0 / 0</div>
                        <div class="score-display" id="totalScoreDisplay"><i class="fas fa-medal"></i> სულ: 0</div>
                    </div>
                    
                    <div id="questionText"></div>
                    <div class="answer-options" id="answerOptions"></div>
                    <div id="quizFeedback"></div>
                    <button id="nextQuestionButton" onclick="handleNextQuestion()"><i class="fas fa-arrow-right"></i> შემდეგი</button>
                    <div class="quiz-progress-container">
                        <div class="quiz-progress-bar" id="quizProgressBar"></div>
                    </div>
                </div>

                <div id="quizEndScreen" style="display: none;">
                    <div class="inner-modal-box">
                        <i class="fas fa-award" style="font-size: 3em; color: var(--accent-gold); margin-bottom: 15px;"></i>
                        <p>ტესტი დასრულებულია! თქვენ დააგროვეთ <span id="finalQuizScore" style="color: var(--accent-green); font-weight: bold;">0</span> ქულა <span id="finalQuizLength" style="font-weight: bold;">0</span>-დან.</p>
                    </div>
                    <div class="input-group" style="align-items: center;">
                        <label for="playerNameInput"><i class="fas fa-user"></i> შეიყვანეთ თქვენი სახელი ლიდერბორდისთვის:</label>
                        <input type="text" id="playerNameInput" placeholder="თქვენი სახელი" maxlength="20">
                    </div>
                    <button onclick="saveScoreAndReset()"><i class="fas fa-save"></i> ქულის შენახვა</button>
                    <button onclick="resetQuizToStartScreen()" style="margin-top: 10px; background-color: var(--container-bg); border: 1px solid var(--border-color);"><i class="fas fa-redo-alt"></i> თავიდან დაწყება</button>
                </div>
            </div>
        </div>
    </div>

    <div id="leaderboardModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('leaderboardModal')">&times;</span>
            <h2><i class="fas fa-crown"></i> ლიდერბორდი</h2>
            <div class="inner-modal-box">
                <ul id="leaderboardList"></ul>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="clearLeaderboard()" style="background-color: var(--accent-red);"><i class="fas fa-eraser"></i> ლიდერბორდის გასუფთავება</button>
            </div>
        </div>
    </div>

    <div id="subscribeModal" class="modal">
        <div class="modal-content">
            <h2><i class="fas fa-gem"></i> Premium გამოწერა</h2>
            <p>თქვენ ნახეთ 10 ბრძოლა. გააგრძელეთ ისტორიის შესწავლა Premium გამოწერით!</p>
            <p class="price">მხოლოდ 1 ლარი!</p>
            <button onclick="handleSubscription()"><i class="fas fa-credit-card"></i> გამოწერა</button>
        </div>
    </div>


    <div id="contributeModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('contributeModal')">&times;</span>
            <h2><i class="fas fa-hands-helping"></i> წვლილის შეტანა</h2>
            <div class="modal-tab-nav">
                <button id="addBattleModalTab" class="active" onclick="showContributeTab('add')"><i class="fas fa-pen-fancy"></i> დაამატე ბრძოლა</button>
                <button id="feedbackModalTab" onclick="showContributeTab('feedback')"><i class="fas fa-comment-dots"></i> უკუკავშირი</button>
            </div>
            <div class="inner-modal-box" id="addBattleContent">
                <h3><i class="fas fa-scroll"></i> ბრძოლის დამატება</h3>
                <form id="addBattleForm" action="https://formspree.io/f/xldnaaqp" method="POST">
                    <label for="newYearInput">წელი:</label>
                    <input type="text" id="newYearInput" name="Year" placeholder="(მაგ: 1999, 44 ძვ. წ.)" required>
                    
                    <label for="newBattleDescription">აღწერა:</label>
                    <textarea id="newBattleDescription" name="Description" rows="6" placeholder="აღწერეთ ბრძოლის დეტალები და მისი მნიშვნელობა..." required></textarea>
                    
                    <label for="newBattleSource">წყარო:</label>
                    <input type="text" id="newBattleSource" name="Source (Optional)" placeholder="წყაროს ბმული ან დასახელება">

                    <label for="submitterEmail">თქვენი ელ.ფოსტა (არასავალდებულო, პასუხისთვის):</label>
                    <input type="email" id="submitterEmail" name="Submitter Email" placeholder="ელ.ფოსტა">
                    
                    <button type="submit"><i class="fas fa-paper-plane"></i> გაგზავნა განსახილველად</button>
                </form>
            </div>
            <div class="inner-modal-box" id="feedbackContent" style="display: none;">
                <h3><i class="fas fa-envelope"></i> გამოგვიგზავნეთ უკუკავშირი</h3>
                <form id="feedbackForm" action="https://formspree.io/f/xldnaaqp" method="POST">
                    <label for="email">თქვენი ელ.ფოსტა (არასავალდებულო):</label>
                    <input type="email" id="email" name="email" placeholder="ელ.ფოსტა (მაგ. user@example.com)">
                    
                    <label for="message">თქვენი შეტყობინება:</label>
                    <textarea id="message" name="message" rows="6" placeholder="აღწერეთ თქვენი შეკითხვა, შენიშვნა ან შეცდომა..." required></textarea>
                    
                    <button type="submit"><i class="fas fa-paper-plane"></i> გაგზავნა</button>
                </form>
            </div>
        </div>
    </div>

    <div class="footer-info">
        <p>აქ თქვენ ნახავთ ინფორმაციას ისტორიულ ომებს წლების მიხედვით.<br>
        ახ. წ. 1 წლიდან დღემდე. <br>
        გთხოვთ გაითვალისწინოთ, რომ საიტი ამჟამად დახვეწის პროცესშია და ყველა ბრძოლა განთავსებული არ არის. <br>
        გთხოვთ მიიღოთ მონაწილეობა თქვენც და <i class="fas fa-plus-circle" style="color: var(--accent-gold);"></i> ღილაკით დაამატოთ ისე წელი და ბრძოლა, რომელიც არ არის დამატებული.</p>
    </div>

    <script>
        // --- JavaScript ნაწილი ---
        const battlesData = {
            '1': 'პირველი საუკუნის დასაწყისი: მიუხედავად იმისა, რომ პირველი წელი არ გამოირჩევა კონკრეტული "ბრძოლით", იგი რომაული მშვიდობის (Pax Romana) და იმპერიის გაძლიერების ხანაა. ამ პერიოდში რომი აგრძელებს გაფართოებას და გავლენას მსოფლიოზე.',
            '9': 'ტევტობურგის ტყის ბრძოლა: გერმანულმა ტომებმა ჰერმანის მეთაურობით გამანადგურებელი მარცხი მიაყენეს რომაულ ლეგიონებს, რითაც შეაჩერეს რომის იმპერიის ექსპანსია გერმანიაში.',
            '60': 'ბოუდიკას აჯანყება: 60 ან 61 წელს ბრიტანელმა დედოფალმა ბოუდიკამ რომაელთა წინააღმდეგ მასშტაბური აჯანყება მოაწყო, თუმცა საბოლოოდ დამარცხდა.',
            '70': 'იერუსალიმის ალყა: რომის იმპერიამ ტიტუსის მეთაურობით აიღო და გაანადგურა იერუსალიმი, რაც ებრაული ომების კულმინაცია იყო.',
            '73 BC': 'სპარტაკის აჯანყება: ძვ.წ. 73-71 წლებში მონა-გლადიატორმა სპარტაკმა უდიდესი აჯანყება მოაწყო რომის რესპუბლიკის წინააღმდეგ, რომელმაც მთელი იტალია მოიცვა.',
            '313': 'მილანის ედიქტი (ბრძოლის შედეგი): 313 წელს იმპერატორ კონსტანტინეს გამარჯვებამ (მილვიუსის ხიდთან 312 წელს) გზა გაუხსნა ქრისტიანობის აღიარებას რომის იმპერიაში.',
            '410': 'რომის გაძარცვა: ვესტგოთებმა ალარიხის მეთაურობით გაძარცვეს რომი, რაც დასავლეთ რომის იმპერიის დასუსტების სიმბოლო გახდა.',
            '451': 'კატალაუნის ველების ბრძოლა: რომაელებმა და ვესტგოთებმა ატილას ჰუნების არმია შეაჩერეს, რითაც ევროპა ჰუნების სრული დაპყრობისგან იხსნეს.',
            '476': 'დასავლეთ რომის იმპერიის დაცემა: რომულუს ავგუსტუსის ტახტიდან ჩამოგდებამ დასავლეთ რომის იმპერიის დასასრული აღნიშნა.',
            '490 BC': 'მარათონის ბრძოლა: ძვ.წ. 490 წელს ათენელებმა დაამარცხეს სპარსეთის მეფე დარიოს I-ის არმია. ეს ბრძოლა ბერძენ-სპარსელთა ომების ერთ-ერთი უმნიშვნელოვანესი ეპიზოდია.',
            '480 BC': 'თერმოპილეს ბრძოლა: ძვ.წ. 480 წელს სპარსეთის უზარმაცარ არმიასა და ბერძნულ გაერთიანებულ ძალებს შორის გამართული ბრძოლა, სადაც 300 სპარტელი გმირულად დაეცა.',
            '333 BC': 'ისოსის ბრძოლა: ძვ.წ. 333 წელს ალექსანდრე დიდმა გადამწყვეტი გამარჯვება მოიპოვა სპარსეთის მეფე დარიუს III-ზე.',
            '331 BC': 'გავგამელის ბრძოლა: ძვ.წ. 331 წელს ალექსანდრე მაკედონელმა საბოლოოდ დაამარცხა დარიოს III-ის სპარსული არმია, რის შემდეგაც აქემენიანთა იმპერიამ არსებობა შეწყვიტა.',
            '216 BC': 'კანეს ბრძოლა: ძვ.წ. 216 წელს ჰანიბალმა, კართაგენელმა გენერალმა, გამანადგურებელი მარცხი მიაყენა რომის რესპუბლიკის არმიას, რაც სამხედრო ისტორიის ერთ-ერთი უდიდესი ტაქტიკური შედევრია.',
            '44 BC': 'იულიუს კეისრის მკვლელობა: მიუხედავად იმისა, რომ ბრძოლა არ იყო, ძვ.წ. 44 წელს იულიუს კეისრის მკვლელობამ რომის რესპუბლიკის დასასრული და იმპერიის დასაწყისი განაპირობა.',
            '31 BC': 'აქციუმის ბრძოლა: ძვ.წ. 31 წელს ოქტავიანემ (შემდგომში იმპერატორი ავგუსტუსი) დაამარცხა მარკუს ანტონიუსი და კლეოპატრა, რამაც რომის რესპუბლიკის სამოქალაქო ომებს ბოლო მოუღო.',
            '732': 'ტურნერის (პუატიეს) ბრძოლა: ფრანკებმა კარლოს მარტელის მეთაურობით დაამარცხეს არაბები, რითაც შეაჩერეს ისლამის ექსპანსია დასავლეთ ევროპაში.',
            '800': 'კარლოს დიდის გამეფება: 800 წელს კარლოს დიდი საღვთო რომის იმპერატორად ეკურთხა, რაც მნიშვნელოვანი ეტაპი იყო ევროპის ისტორიაში.',
            '910': 'ლეხფელდის ბრძოლა (პირველი): უნგრელებმა გაანადგურეს ბავარიის არმია, რამაც აღმოსავლეთ ევროპაში მათი გავლენა გაზარდა.',
            '1066': 'ჰასტინგსის ბრძოლა: 1066 წლის 14 ოქტომბერს, ნორმანთა ჰერცოგმა უილიამ დამპყრობელმა დაამარცხა ინგლისის ანგლო-საქსური არმია. ამ ბრძოლამ ინგლისის ისტორია სამუდამოდ შეცვალა.',
            '1071': 'მანასკერტის ბრძოლა: თურქ-სელჩუკებმა სულთან ალფ-არსლანის მეთაურობით დაამარცხეს ბიზანტიის იმპერიის არმია, რამაც მცირე აზიაში თურქების დასახლებას დაუდო სათავე.',
            '1096': 'პირველი ჯვაროსნული ლაშქრობის დასაწყისი: 1096 წელს დაიწყო პირველი ჯვაროსნული ლაშქრობა წმინდა მიწის გასათავისუფლებლად.',
            '1121': 'დიდგორის ბრძოლა: 1121 წლის 12 აგვისტოს დავით აღმაშენებელმა "ძლევაი საკვირველი" მოიპოვა თურქ-სელჩუკთა კოალიციურ ლაშქარზე, რაც საქართველოს "ოქროს ხანის" დასაწყისად იქცა.',
            '1195': 'შამქორის ბრძოლა: საქართველოს ლაშქარმა თამარ მეფის მმართველობის პერიოდში, დავით სოსლანის სარდლობით, დაამარცხა აზერბაიჯანის ათაბაგი აბუ ბაქრი.',
            '1203': 'ბასიანის ბრძოლა: თამარის ეპოქის კიდევ ერთი დიდი გამარჯვება, სადაც ქართველებმა რუმის სულთნის, რუქნ ად-დინის, კოალიციური ლაშქარი დაამარცხეს.',
            '1204': 'კონსტანტინოპოლის აღება: მეოთხე ჯვაროსნული ლაშქრობის დროს ჯვაროსნებმა აიღეს და გაძარცვეს კონსტანტინოპოლი, რაც ბიზანტიის იმპერიის დასუსტების კრიტიკული მომენტი იყო.',
            '1212': 'ლას ნავას დე ტოლოსას ბრძოლა: ქრისტიანულმა ესპანურმა სამეფოებმა დაამარცხეს ალმოჰადები, რამაც რეკონკისტის მიმდინარეობაზე დიდი გავლენა მოახდინა.',
            '1241': 'მოჰის ბრძოლა: მონღოლებმა ბათო-ყაენის მეთაურობით დაამარცხეს უნგრული არმია, რამაც აღმოსავლეთ ევროპაში მონღოლთა შემოჭრა დაადასტურა.',
            '1346': 'კრესის ბრძოლა: ასწლიანი ომის დროს ინგლისელებმა გრძელი მშვილდების გამოყენებით გაანადგურეს ფრანგული არმია, რაც სამხედრო ტაქტიკის რევოლუცია იყო.',
            '1380': 'კულიკოვოს ბრძოლა: რუსულმა ძალებმა დიმიტრი დონსკოის მეთაურობით დაამარცხეს ოქროს ურდო, რაც რუსეთის გათავისუფლებისკენ გადადგმული ნაბიჯი იყო.',
            '1410': 'გრუნვალდის ბრძოლა: პოლონეთისა და ლიტვის გაერთიანებულმა ძალებმა დაამარცხეს ტევტონთა ორდენი, რაც შუა საუკუნეების ევროპის ერთ-ერთი უდიდესი ბრძოლა იყო.',
            '1415': 'აჟენკურის ბრძოლა: ინგლისის მეფე ჰენრი V-მ მოულოდნელი გამარჯვება მოიპოვა საფრანგეთის უზარმაცარ არმიაზე ასწლიანი ომის დროს.',
            '1429': 'ორლეანის ალყის გარღვევა: ჟანა დ’არკის მეთაურობით ფრანგებმა გაარღვიეს ინგლისელების მიერ ალყაშემორტყმული ქალაქი ორლეანი, რაც გარდამტეხი მომენტი იყო ასწლიან ომში.',
            '1453': 'კონსტანტინოპოლის დაცემა: ოსმალეთის სულთანმა მეჰმედ II-მ აიღო კონსტანტინოპოლი, რითაც ბოლო მოუღო ბიზანტიის იმპერიას. ეს თარიღი ხშირად მიიჩნევა შუა საუკუნეების დასასრულად.',
            '1492': 'გრანადის დაცემა და ამერიკის აღმოჩენა: ესპანეთში დასრულდა რეკონკისტა გრანადის აღებით. იმავე წელს ქრისტეფორე კოლუმბმა ამერიკის კონტინენტს მიაღწია.',
            '1526': 'მოჰაჩის ბრძოლა: ოსმალეთის იმპერიამ სულეიმან დიდებულის მეთაურობით დაამარცხა უნგრეთის სამეფო, რამაც უნგრეთის დაყოფა და ოსმალეთის ექსპანსია გამოიწვია ცენტრალურ ევროპაში.',
            '1571': 'ლეპანტოს ბრძოლა: წმინდა ლიგის ფლოტმა დაამარცხა ოსმალეთის ფლოტი, რამაც შეაჩერა ოსმალეთის საზღვაო ექსპანსია ხმელთაშუა ზღვაში.',
            '1588': 'ესპანური არმადის დამარცხება: ინგლისურმა ფლოტმა დაამარცხა ესპანური "უძლეველი არმადა", რითაც ინგლისი საზღვაო ძალად იქცა და ესპანეთის ჰეგემონია შესუსტდა.',
            '1590': 'ივრის ბრძოლა: საფრანგეთის მეფე ანრი IV-მ გადამწყვეტი გამარჯვება მოიპოვა კათოლიკური ლიგის ძალებზე, რაც საფრანგეთის რელიგიური ომების მნიშვნელოვანი ეტაპი იყო.',
            '1648': 'ვესტფალიის ზავი: დასრულდა ოცდაათწლიანი ომი, რითაც შეიქმნა თანამედროვე ეროვნული სახელმწიფოების სისტემის საფუძველი ევროპაში.',
            '1659': 'ბახტრიონის ბრძოლა: კახეთის აჯანყებულებმა ბახტრიონის ციხესთან დაამარცხეს ყიზილბაშები, რითაც აღიკვეთა კახეთში თურქმენული ტომების ჩასახლების მცდელობა.',
            '1683': 'ვენის ალყა: პოლონეთის მეფის, იან III სობესკის, მეთაურობით ქრისტიანულმა მოკავშირეებმა ვენასთან დაამარცხეს ოსმალეთის არმია, რამაც ოსმალეთის ექსპანსია ევროპაში საბოლოოდ შეაჩერა.',
            '1709': 'პოლტავის ბრძოლა: რუსეთის მეფე პეტრე I-მა გადამწყვეტი გამარჯვება მოიპოვა შვედეთის მეფე კარლ XII-ზე, რამაც რუსეთი ჩრდილოეთ ევროპის დომინანტ ძალად აქცია.',
            '1770': 'ასპინძის ბრძოლა: ერეკლე II-ის მეთაურობით ქართლ-კახეთის მცირერიცხოვანმა ჯარმა ბრწყინვალე გამარჯვება მოიპოვა ოსმალთა კოალიციურ ლაშქარზე.',
            '1775': 'ლექსინგტონისა და კონკორდის ბრძოლები: დაიწყო ამერიკის რევოლუციური ომი ბრიტანელებსა და ამერიკელ კოლონისტებს შორის პირველი შეტაკებებით.',
            '1777': 'სარატოგას ბრძოლა: ამერიკის რევოლუციური ომის გარდამტეხი მომენტი, სადაც ამერიკულმა ძალებმა დაამარცხეს ბრიტანელები, რამაც საფრანგეთი დაარწმუნა ამერიკელების მხარდაჭერაში.',
            '1789': 'ბასტილიის აღება: 14 ივლისს პარიზელებმა აიღეს ბასტილიის ციხე, რითაც საფრანგეთის დიდი რევოლუცია დაიწყო.',
            '1795': 'კრწანისის ბრძოლა: თბილისთან გამართული ტრაგიკული ბრძოლა ქართლ-კახეთის სამეფოსა და ირანის შაჰ აღა-მაჰმად-ხანის არმიას შორის. მიუხედავად ერეკლე II-ის და 300 არაგველის გმირობისა, ქართული ჯარი დამარცხდა და თბილისი განადგურდა.',
            '1805': 'ტრაფალგარის ბრძოლა: ბრიტანულმა ფლოტმა ადმირალ ნელსონის მეთაურობით გაანადგურა საფრანგეთ-ესპანეთის გაერთიანებული ფლოტი, რითაც უზრუნველყო ბრიტანეთის საზღვაო ჰეგემონია.',
            '1812': 'ბოროდინოს ბრძოლა: ნაპოლეონის საფრანგეთის არმიასა და რუსეთის იმპერიის არმიას შორის გამართული ერთ-ერთი უსისხლიანესი ბრძოლა, რამაც ნაპოლეონს მოსკოვისკენ გზა გაუხსნა.',
            '1815': 'ვატერლოოს ბრძოლა: 18 ივნისს გამართული ბრძოლა, რომელშიც ნაპოლეონ ბონაპარტე საბოლოოდ დამარცხდა მოკავშირეთა ძალებთან, რითაც დასრულდა ნაპოლეონის ომების ერა.',
            '1853': 'ყირიმის ომის დასაწყისი: 1853-1856 წლებში მიმდინარე ომი რუსეთის იმპერიასა და ბრიტანეთის, საფრანგეთის, ოსმალეთისა და სარდინიის კოალიციას შორის.',
            '1863': 'გეტისბერგის ბრძოლა: ამერიკის სამოქალაქო ომის გარდამტეხი და ყველაზე მასშტაბური ბრძოლა, რომელიც კავშირის გამარჯვებით დასრულდა.',
            '1870': 'სედანის ბრძოლა: ფრანკო-პრუსიის ომის დროს პრუსიამ დაამარცხა საფრანგეთი, რამაც გამოიწვია მეორე საფრანგეთის იმპერიის დაცემა და გერმანიის გაერთიანება.',
            '1905': 'ცუსიმის ბრძოლა: რუსეთ-იაპონიის ომის დროს იაპონიის ფლოტმა სრულიად გაანადგურა რუსეთის ესკადრა, რამაც ომის ბედი გადაწყვიტა.',
            '1914': 'მარნის ბრძოლა (პირველი): პირველი მსოფლიო ომის დასაწყისში ფრანგულმა და ბრიტანულმა ძალებმა შეაჩერეს გერმანიის წინსვლა პარიზისკენ.',
            '1916': 'ვერდენის და სომის ბრძოლები: პირველი მსოფლიო ომის ორი ყველაზე ხანგრძლივი და სისხლიანი ბრძოლა დასავლეთის ფრონტზე.',
            '1918': 'პირველი მსოფლიო ომის დასასრული: 11 ნოემბერს კომპიენის ზავით დასრულდა პირველი მსოფლიო ომი.',
            '1921': 'კოჯორ-ტაბახმელას ბრძოლა: თებერვალში საქართველოს არმიამ და იუნკრებმა დიდი წინააღმდეგობა გაუწიეს რუსეთის წითელ არმიას, მაგრამ საბოლოოდ საქართველო ოკუპირებულ იქნა.',
            '1939': 'პოლონეთში შეჭრა: 1 სექტემბერს გერმანიის პოლონეთში შეჭრით დაიწყო მეორე მსოფლიო ომი.',
            '1940': 'ბრიტანეთის ბრძოლა: გერმანიის საჰაერო ძალების (ლუფტვაფე) თავდასხმა ბრიტანეთზე. ბრიტანეთის გამარჯვებამ ხელი შეუშალა გერმანიის ბრიტანეთში შეჭრას.',
            '1941': 'პერლ ჰარბორზე თავდასხმა: 7 დეკემბერს იაპონიის თავდასხმამ პერლ ჰარბორზე აშშ ჩააბა მეორე მსოფლიო ომში.',
            '1942': 'სტალინგრადის ბრძოლა: მეორე მსოფლიო ომის აღმოსავლეთის ფრონტზე გარდამტეხი მომენტი. ბრძოლა, რომელმაც საბჭოთა კავშირს სტრატეგიული უპირატესობა მოუტანა.',
            '1943': 'კურსკის ბრძოლა: მსოფლიო ისტორიაში უდიდესი სატანკო ბრძოლა, რომელიც საბჭოთა კავშირის გამარჯვებით დასრულდა.',
            '1944': 'ნორმანდიის დესანტი (D-Day): 6 ივნისს მოკავშირეებმა ნორმანდიაში გადმოსხდნენ, რითაც დასავლეთის ფრონტი გაიხსნა მეორე მსოფლიო ომში.',
            '1945': 'ბერლინის ბრძოლა და მეორე მსოფლიო ომის დასასრული: აპრილ-მაისში წითელმა არმიამ აიღო ბერლინი, რასაც მოჰყვა გერმანიის კაპიტულაცია. ომი საბოლოოდ დასრულდა იაპონიის კაპიტულაციით სექტემბერში.',
            '1954': 'დიენ ბიენ ფუს ბრძოლა: ვიეტნამის ძალებმა დაამარცხეს ფრანგები, რამაც დაასრულა საფრანგეთის კოლონიური მმართველობა ინდოჩინეთში.',
            '1962': 'კარიბის კრიზისი: მიუხედავად იმისა, რომ პირდაპირი ბრძოლა არ მომხდარა, აშშ-სა და საბჭოთა კავშირს შორის ბირთვულმა დაპირისპირებამ მსოფლიო ომის ზღვარზე მიიყვანა.',
            '1968': 'ტეტის შეტევა: ვიეტნამის ომის დროს ვიეტკონგისა და ჩრდილოეთ ვიეტნამის არმიის ფართომასშტაბიანმა შეტევამ შეცვალა ამერიკული საზოგადოების დამოკიდებულება ომის მიმართ.',
            '1979': 'საბჭოთა კავშირის შეჭრა ავღანეთში: 1979-1989 წლებში მიმდინარე კონფლიქტი, რომელმაც დიდი გავლენა მოახდინა ცივი ომის დასასრულზე.',
            '1989': 'ბერლინის კედლის დაცემა: 9 ნოემბერს ბერლინის კედლის დაცემამ ცივი ომის დასასრული და გერმანიის გაერთიანება მოასწავა.',
            '1991': 'ოპერაცია "უდაბნოს ქარიშხალი": აშშ-ის მეთაურობით კოალიციურმა ძალებმა გაათავისუფლეს ქუვეითი ერაყის ოკუპაციისგან.',
            '2001': '11 სექტემბრის ტერაქტები: აშშ-ზე განხორციელდა ტერორისტული თავდასხმები, რამაც გამოიწვია "ტერორიზმთან ომის" დაწყება.',
            '2008': 'რუსეთ-საქართველოს ომი: აგვისტოში რუსეთსა და საქართველოს შორის შეიარაღებული კონფლიქტი, რის შედეგადაც რუსეთმა საქართველოს ტერიტორიების ოკუპაცია მოახდინა.',
            '2014': 'ყირიმის ანექსია და დონბასის ომი: რუსეთმა მოახდინა ყირიმის ანექსია და დაიწყო კონფლიქტი აღმოსავლეთ უკრაინაში.',
            '2022': 'უკრაინაში სრულმასშტაბიანი შეჭრა: 24 თებერვალს რუსეთის სრულმასშტაბიანი შეჭრა უკრაინაში, რამაც ევროპაში მეორე მსოფლიო ომის შემდეგ ყველაზე დიდი ომი გამოიწვია.',
            '2025': 'პროგნოზი: 2025 წელი მოსალოდნელია იყოს მნიშვნელოვანი წელი ტექნოლოგიური პროგრესის, კოსმოსური კვლევებისა და გლობალური თანამშრომლობის კუთხით. შესაძლოა, ახალი გამოწვევებიც გაჩნდეს ჯანდაცვისა და ეკონომიკის სფეროებში.'
        };

        let searchHistory = [];
        let knownBattles = [];
        let unknownBattles = [];
        const MAX_HISTORY_ITEMS = 10;
        let lastSearchedBattle = null;
        let pageViews = 0;
        const MAX_FREE_VIEWS = 10;
        let isSubscribed = localStorage.getItem('isSubscribed') === 'true';

        let currentQuestion = null;
        let quizScore = 0;
        let questionsAnswered = 0;
        let quizLength = 0;
        let questionsAskedThisQuiz = []; 
        let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
        let countdownInterval;

        const quizEligibleBattles = Object.keys(battlesData).filter(year => {
            const description = battlesData[year];
            return description.length > 50 && 
                   !description.includes('პროგნოზი') && 
                   !description.includes('მიმდინარე მოვლენები') &&
                   !description.includes('კარიბის კრიზისი') && 
                   !description.includes('ბერლინის კედლის დაცემა');
        }).map(year => ({
            year: year,
            name: extractBattleName(battlesData[year]),
            fullDescription: battlesData[year]
        }));


        function getBattleInfo() {
            if (!isSubscribed && pageViews >= MAX_FREE_VIEWS) {
                openModal('subscribeModal');
                return;
            }

            let yearInput = document.getElementById('yearInput').value.trim();
            const battleInfoDiv = document.getElementById('battleInfo');
            const knowledgeFeedbackDiv = document.getElementById('knowledgeFeedback');

            let info = '';
            let currentBattleKey = null;

            yearInput = yearInput.toLowerCase().replace(/ძვ\. ?წ\.?/g, 'bc').replace(/\s+/g, ' ');
            let cleanedYear = yearInput.replace(' bc', '');
            let displayYear = yearInput;

            if (yearInput.includes('bc')) {
                displayYear = cleanedYear + ' ძვ. წ.';
            } else if (!isNaN(parseInt(yearInput))) {
                displayYear = parseInt(yearInput).toString();
            }

            if (isNaN(parseInt(cleanedYear)) || !cleanedYear) {
                info = '<p>გთხოვთ, შეიყვანოთ სწორი წელი.</p>';
                lastSearchedBattle = null;
            } else {
                let actualYearKey = yearInput.includes('bc') ? cleanedYear + ' BC' : cleanedYear;

                if (battlesData[actualYearKey]) {
                    info = `<p>${battlesData[actualYearKey]}</p>`;
                    currentBattleKey = actualYearKey;
                    
                    if (!isSubscribed) {
                        pageViews++;
                        localStorage.setItem('pageViews', pageViews);
                        if (pageViews >= MAX_FREE_VIEWS) {
                            setTimeout(() => openModal('subscribeModal'), 500);
                        }
                    }
                } else {
                    info = `<p>ამ წლისთვის (${displayYear.toUpperCase()}) ინფორმაცია არ მოიძებნა. სცადეთ მაგალითები: 1121, 1453, 1942, 490 ძვ. წ.</p>`;
                    lastSearchedBattle = null;
                }
            }
            
            battleInfoDiv.innerHTML = info;
            knowledgeFeedbackDiv.style.display = currentBattleKey ? 'flex' : 'none';

            if (currentBattleKey) {
                lastSearchedBattle = {
                    year: displayYear,
                    key: currentBattleKey,
                    description: battlesData[currentBattleKey]
                };
            }

            if (yearInput && !isNaN(parseInt(cleanedYear))) { 
                const historyItemToStore = { year: displayYear, key: yearInput };
                searchHistory = searchHistory.filter(item => item.key !== historyItemToStore.key);
                searchHistory.unshift(historyItemToStore);
                if (searchHistory.length > MAX_HISTORY_ITEMS) searchHistory.pop();
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
                updateHistoryList();
            }
        }

        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (searchHistory.length === 0) {
                historyList.innerHTML = '<li style="justify-content: center; color: var(--text-primary);"><i class="fas fa-hourglass-empty" style="margin-right: 8px;"></i>ისტორია ცარიელია.</li>';
                return;
            }

            searchHistory.forEach((item, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span>${item.year.toUpperCase()}</span> <span class="clear-history-item" data-index="${index}" data-list="history"><i class="fas fa-trash-alt"></i> წაშლა</span>`;
                
                listItem.querySelector('span:first-child').onclick = () => {
                    document.getElementById('yearInput').value = item.key;
                    getBattleInfo();
                    closeModal('archiveModal');
                };

                listItem.querySelector('.clear-history-item').onclick = (e) => {
                    e.stopPropagation();
                    removeListItem('history', parseInt(e.currentTarget.dataset.index));
                };
                historyList.appendChild(listItem);
            });
        }

        function addBattleToKnowledgeList(type) {
            if (!lastSearchedBattle) return;
            const list = type === 'known' ? knownBattles : unknownBattles;
            const otherList = type === 'known' ? unknownBattles : knownBattles;
            if (list.some(item => item.key === lastSearchedBattle.key)) return;
            const otherIndex = otherList.findIndex(item => item.key === lastSearchedBattle.key);
            if (otherIndex > -1) otherList.splice(otherIndex, 1);
            list.unshift(lastSearchedBattle);
            localStorage.setItem('knownBattles', JSON.stringify(knownBattles));
            localStorage.setItem('unknownBattles', JSON.stringify(unknownBattles));
            alert(`ბრძოლა "${lastSearchedBattle.year}" დაემატა "${type === 'known' ? 'ვიცი' : 'არ ვიცი'}" სიაში!`);
            updateKnowledgeLists();
        }

        function updateKnowledgeLists() {
            updateListDisplay('knownBattlesList', knownBattles, 'known');
            updateListDisplay('unknownBattlesList', unknownBattles, 'unknown');
        }

        function updateListDisplay(ulId, dataList, type) {
            const ul = document.getElementById(ulId);
            ul.innerHTML = '';

            if (dataList.length === 0) {
                ul.innerHTML = `<li style="justify-content: center; color: var(--text-primary);"><i class="fas fa-folder-open" style="margin-right: 8px;"></i>სია ცარიელია.</li>`;
                return;
            }

            dataList.forEach((item, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span>${item.year.toUpperCase()} - ${extractBattleName(item.description)}</span> <span class="clear-history-item" data-index="${index}" data-list="${type}"><i class="fas fa-trash-alt"></i> წაშლა</span>`;
                
                listItem.querySelector('span:first-child').onclick = () => {
                    document.getElementById('yearInput').value = item.key;
                    getBattleInfo();
                    closeModal('archiveModal');
                };

                listItem.querySelector('.clear-history-item').onclick = (e) => {
                    e.stopPropagation();
                    removeListItem(type, parseInt(e.currentTarget.dataset.index));
                };
                ul.appendChild(listItem);
            });
        }

        function removeListItem(listType, index) {
            const listMap = { history: searchHistory, known: knownBattles, unknown: unknownBattles };
            listMap[listType].splice(index, 1);
            localStorage.setItem(`${listType}Battles`, JSON.stringify(listMap[listType])); // For known/unknown
            if (listType === 'history') localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            updateHistoryList();
            updateKnowledgeLists();
        }

        function loadKnowledgeLists() {
            knownBattles = JSON.parse(localStorage.getItem('knownBattles') || '[]');
            unknownBattles = JSON.parse(localStorage.getItem('unknownBattles') || '[]');
            updateKnowledgeLists();
        }

        // --- Quiz Functions ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function extractBattleName(description) {
            let name = description.split(':')[0].trim();
            // Complex name extraction logic simplified for brevity
            if (name.length > 50) name = name.substring(0, 50) + '...';
            return name.replace(/[,.!?]$/, '');
        }

        function prepareQuiz() {
            const quizLengthSelect = document.getElementById('quizLengthSelect');
            const customQuizLengthInput = document.getElementById('customQuizLengthInput');
            quizLength = quizLengthSelect.value === 'custom' ? parseInt(customQuizLengthInput.value) : parseInt(quizLengthSelect.value);

            if (isNaN(quizLength) || quizLength <= 0 || quizLength > quizEligibleBattles.length) {
                alert(`გთხოვთ, შეიყვანოთ კითხვების სწორი რაოდენობა (1-დან ${quizEligibleBattles.length}-მდე).`);
                return;
            }

            document.getElementById('quizStartScreen').style.display = 'none';
            const countdownDiv = document.getElementById('quizCountdown');
            countdownDiv.style.display = 'block';
            let count = 3;
            countdownDiv.textContent = count;
            countdownInterval = setInterval(() => {
                count--;
                countdownDiv.textContent = count > 0 ? count : 'დაიწყო!';
                if (count <= 0) {
                    clearInterval(countdownInterval);
                    countdownDiv.style.display = 'none';
                    startQuiz();
                }
            }, 1000);
        }

        function startQuiz() {
            document.getElementById('quizContent').style.display = 'block';
            quizScore = 0;
            questionsAnswered = 0;
            questionsAskedThisQuiz = [];
            document.getElementById('quizScore').innerHTML = `<i class="fas fa-star"></i> ქულა: 0 / 0`;
            document.getElementById('totalScoreDisplay').innerHTML = `<i class="fas fa-medal"></i> სულ: ${localStorage.getItem('totalQuizScore') || 0}`;
            updateProgressBar();
            generateQuestion();
        }

        function generateQuestion() {
            if (questionsAnswered >= quizLength) {
                endQuiz();
                return;
            }

            document.getElementById('quizFeedback').textContent = '';
            document.getElementById('nextQuestionButton').style.display = 'none';

            const availableBattles = quizEligibleBattles.filter(battle => !questionsAskedThisQuiz.includes(battle.year));
            if (availableBattles.length < 4) {
                 endQuiz(); return; // Not enough questions left
            }
            
            const correctBattle = availableBattles[Math.floor(Math.random() * availableBattles.length)];
            questionsAskedThisQuiz.push(correctBattle.year);
            const questionType = Math.random() < 0.5 ? 'yearByName' : 'nameByYear';

            currentQuestion = {
                correctYear: correctBattle.year,
                correctName: correctBattle.name,
                fullDescription: correctBattle.fullDescription,
                type: questionType
            };

            let options = [];
            const otherBattles = shuffleArray(quizEligibleBattles.filter(b => b.year !== correctBattle.year));
            
            if (questionType === 'yearByName') {
                document.getElementById('questionText').innerHTML = `რომელ წელს მოხდა <span>${currentQuestion.correctName}</span>?`;
                options = [currentQuestion.correctYear, ...otherBattles.slice(0, 3).map(b => b.year)];
            } else { // nameByYear
                document.getElementById('questionText').innerHTML = `რომელი ბრძოლა მოხდა <span>${currentQuestion.correctYear.toUpperCase()}</span> წელს?`;
                options = [currentQuestion.correctName, ...otherBattles.slice(0, 3).map(b => b.name)];
            }
            
            const answerOptionsDiv = document.getElementById('answerOptions');
            answerOptionsDiv.innerHTML = '';
            shuffleArray(options).forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.onclick = () => checkAnswer(option);
                answerOptionsDiv.appendChild(button);
            });
        }

        function checkAnswer(selectedOption) {
            const feedbackDiv = document.getElementById('quizFeedback');
            const answerButtons = document.querySelectorAll('#answerOptions button');
            
            const isCorrect = (currentQuestion.type === 'yearByName' && selectedOption === currentQuestion.correctYear) || 
                              (currentQuestion.type === 'nameByYear' && selectedOption === currentQuestion.correctName);
            const correctAnswerText = currentQuestion.type === 'yearByName' ? currentQuestion.correctYear : currentQuestion.correctName;

            answerButtons.forEach(button => {
                button.classList.add('disabled');
                if (button.textContent === correctAnswerText) {
                    button.classList.add('correct');
                } else if (button.textContent === selectedOption) {
                    button.classList.add('incorrect');
                }
            });

            if (isCorrect) {
                feedbackDiv.innerHTML = '<i class="fas fa-check-circle" style="color: var(--accent-green);"></i> სწორია! 🎉';
                quizScore++;
            } else {
                feedbackDiv.innerHTML = `<i class="fas fa-times-circle" style="color: var(--accent-red);"></i> არასწორია. <i class="fas fa-question-circle reveal-answer-icon" title="სწორი პასუხის ჩვენება"></i>`;
                feedbackDiv.querySelector('.reveal-answer-icon').onclick = () => {
                    feedbackDiv.innerHTML = `<i class="fas fa-times-circle" style="color: var(--accent-red);"></i> სწორი პასუხია: <strong style="color: var(--accent-gold);">${correctAnswerText}</strong>`;
                };
            }
            
            questionsAnswered++;
            document.getElementById('quizScore').innerHTML = `<i class="fas fa-star"></i> ქულა: ${quizScore} / ${questionsAnswered}`;
            document.getElementById('nextQuestionButton').textContent = (questionsAnswered < quizLength) ? 'შემდეგი' : 'დასრულება';
            document.getElementById('nextQuestionButton').style.display = 'inline-flex';
            updateProgressBar();
        }

        function handleNextQuestion() {
            generateQuestion();
        }

        function endQuiz() {
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('quizEndScreen').style.display = 'flex';
            document.getElementById('finalQuizScore').textContent = quizScore;
            document.getElementById('finalQuizLength').textContent = quizLength;
            document.getElementById('playerNameInput').value = `მოთამაშე ${Math.floor(Math.random() * 1000)}`;
        }

        function saveScoreAndReset() {
            const playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) { alert('გთხოვთ, შეიყვანოთ თქვენი სახელი!'); return; }

            leaderboard.push({ name: playerName, score: quizScore, date: new Date().toLocaleDateString() });
            leaderboard.sort((a, b) => b.score - a.score).splice(10); // Keep top 10
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
            
            let totalScore = (parseInt(localStorage.getItem('totalQuizScore')) || 0) + quizScore;
            localStorage.setItem('totalQuizScore', totalScore);

            resetQuizToStartScreen();
            closeModal('testModal');
            openModal('leaderboardModal');
        }

        function updateProgressBar() {
            document.getElementById('quizProgressBar').style.width = `${(questionsAnswered / quizLength) * 100}%`;
        }

        function resetQuizToStartScreen() {
            clearInterval(countdownInterval);
            document.getElementById('quizStartScreen').style.display = 'flex';
            document.getElementById('quizContent').style.display = 'none';
            document.getElementById('quizEndScreen').style.display = 'none';
            document.getElementById('quizCountdown').style.display = 'none';
            document.getElementById('quizLengthSelect').value = '10';
            document.getElementById('customQuizLengthInput').style.display = 'none';
            document.getElementById('quizProgressBar').style.width = '0%';
        }

        // --- Leaderboard Functions ---
        function updateLeaderboardDisplay() {
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = '';
            
            if (leaderboard.length === 0) {
                leaderboardList.innerHTML = '<li style="justify-content: center; color: var(--text-primary);"><i class="fas fa-sad-tear" style="margin-right: 8px;"></i>ლიდერბორდი ცარიელია.</li>';
                return;
            }

            leaderboard.forEach((entry, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span class="rank">${index + 1}.</span> <span class="name">${entry.name}</span> <span class="score">${entry.score} ქულა</span> <small class="date" style="color: var(--text-secondary);">(${entry.date})</small>`;
                leaderboardList.appendChild(listItem);
            });
        }

        function clearLeaderboard() {
            if (confirm('ნამდვილად გსურთ ლიდერბორდის გასუფთავება?')) {
                leaderboard = [];
                localStorage.removeItem('leaderboard');
                localStorage.setItem('totalQuizScore', '0');
                document.getElementById('totalScoreDisplay').innerHTML = `<i class="fas fa-medal"></i> სულ: 0`;
                updateLeaderboardDisplay();
            }
        }

        // --- Subscription Functions ---
        function handleSubscription() {
            isSubscribed = true;
            localStorage.setItem('isSubscribed', 'true');
            pageViews = 0;
            localStorage.setItem('pageViews', '0');
            alert('გამოწერა წარმატებით გააქტიურდა! გმადლობთ მხარდაჭერისთვის.');
            closeModal('subscribeModal');
        }


        // --- Tab and Modal Functions ---
        function openModal(modalId, defaultTab = null) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);

            if (modalId === 'archiveModal') { updateHistoryList(); loadKnowledgeLists(); showArchiveTab(defaultTab || 'history'); }
            else if (modalId === 'testModal') { resetQuizToStartScreen(); }
            else if (modalId === 'contributeModal') { showContributeTab(defaultTab || 'add'); }
            else if (modalId === 'leaderboardModal') { updateLeaderboardDisplay(); }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            setTimeout(() => { modal.style.display = 'none'; }, 400);
        }
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                if (event.target.id !== 'subscribeModal') {
                    closeModal(event.target.id);
                }
            }
        }

        function showArchiveTab(tabType) {
            ['history', 'known', 'unknown'].forEach(type => {
                document.getElementById(`${type}Content`).style.display = 'none';
                document.getElementById(`${type}ModalTab`).classList.remove('active');
            });
            document.getElementById(`${tabType}Content`).style.display = 'block';
            document.getElementById(`${tabType}ModalTab`).classList.add('active');
        }

        function showContributeTab(tabType) {
            ['addBattle', 'feedback'].forEach(type => {
                document.getElementById(`${type}Content`).style.display = 'none';
                document.getElementById(`${type === 'addBattle' ? 'add' : type}ModalTab`).classList.remove('active');
            });
            document.getElementById(`${tabType === 'add' ? 'addBattle' : tabType}Content`).style.display = 'block';
            document.getElementById(`${tabType}ModalTab`).classList.add('active');
        }
        
        document.getElementById('quizLengthSelect').addEventListener('change', function() {
            const customInput = document.getElementById('customQuizLengthInput');
            customInput.style.display = this.value === 'custom' ? 'block' : 'none';
            if (this.value === 'custom') customInput.focus();
        });
        
        async function handleFormSubmit(event, successMessage, errorMessage) {
            event.preventDefault();
            const form = event.target;
            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    body: new FormData(form),
                    headers: { 'Accept': 'application/json' }
                });
                if (response.ok) {
                    alert(successMessage);
                    form.reset();
                    closeModal('contributeModal');
                } else {
                    alert(errorMessage);
                }
            } catch (error) {
                alert('ქსელური შეცდომა. გთხოვთ, შეამოწმოთ თქვენი ინტერნეტ კავშირი.');
            }
        }

        document.getElementById('feedbackForm').addEventListener('submit', (e) => handleFormSubmit(e, 'გმადლობთ უკუკავშირისთვის!', 'დაფიქსირდა შეცდომა.'));
        document.getElementById('addBattleForm').addEventListener('submit', (e) => handleFormSubmit(e, 'გმადლობთ წვლილისთვის!', 'დაფიქსირდა შეცდომა.'));

        document.addEventListener('DOMContentLoaded', () => {
            searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            updateHistoryList();
            loadKnowledgeLists();
            updateLeaderboardDisplay(); 
            document.getElementById('battleInfo').innerHTML = '<p>შეიყვანეთ წელი და გაიგეთ მეტი ისტორიული ბრძოლების შესახებ!</p>';
            document.getElementById('totalScoreDisplay').innerHTML = `<i class="fas fa-medal"></i> სულ: ${localStorage.getItem('totalQuizScore') || 0}`;
            pageViews = parseInt(localStorage.getItem('pageViews') || '0');
            isSubscribed = localStorage.getItem('isSubscribed') === 'true';
        });

        window.addEventListener('beforeunload', () => {
            localStorage.setItem('pageViews', pageViews);
        });
    </script>
</body>
</html>